<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EAP Analyzer - Dashboard Прогресса</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="css/styles.css" rel="stylesheet" />
  </head>
  <body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#">
          <i class="bi bi-bar-chart-line"></i>
          EAP Analyzer Dashboard
        </a>
        <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
          <!-- Live Update Button -->
          <button
            id="live-update-btn"
            class="btn btn-outline-light btn-sm me-3"
            onclick="dashboard.refreshLiveData()"
            title="Обновить данные из live-отчета"
          >
            <i class="bi bi-arrow-clockwise"></i>
            <span class="d-none d-md-inline">Live Update</span>
          </button>

          <span class="navbar-text me-3">
            <small class="text-muted">Генерировать отчет:</small>
            <code
              class="bg-dark text-warning px-2 py-1 rounded ms-1"
              style="cursor: pointer; user-select: all"
              onclick="copyToClipboard('node live-generator.cjs')"
              title="Нажмите чтобы скопировать команду"
            >
              node live-generator.cjs
            </code>
          </span>
          <span class="navbar-text">
            <i class="bi bi-calendar3"></i>
            <span id="last-update">11.09.2025</span>
          </span>
        </div>
      </div>
    </nav>

    <!-- Controls -->
    <div class="container-fluid mt-3">
      <!-- Фильтры категорий -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-light">
              <h6 class="mb-0">
                <i class="bi bi-funnel"></i> Фильтр по категориям
                <small class="text-muted">(<span id="category-count">12</span> категорий)</small>
              </h6>
            </div>
            <div class="card-body p-3">
              <div class="d-flex gap-2 flex-wrap" id="category-filters">
                <button
                  class="btn btn-primary active"
                  data-category="all"
                  title="Показать все компоненты"
                >
                  <i class="bi bi-grid-3x3-gap"></i> Все
                </button>
                <button
                  class="btn btn-outline-success"
                  data-category="testing"
                  title="Тестирование и контроль качества"
                >
                  <i class="bi bi-check-circle"></i> Testing
                </button>
                <button
                  class="btn btn-outline-danger"
                  data-category="security"
                  title="Безопасность и анализ угроз"
                >
                  <i class="bi bi-shield-check"></i> Security
                </button>
                <button
                  class="btn btn-outline-warning"
                  data-category="performance"
                  title="Производительность и оптимизация"
                >
                  <i class="bi bi-speedometer2"></i> Performance
                </button>
                <button
                  class="btn btn-outline-info"
                  data-category="docker"
                  title="Контейнеризация и развертывание"
                >
                  <i class="bi bi-box"></i> Docker
                </button>
                <button
                  class="btn btn-outline-secondary"
                  data-category="dependencies"
                  title="Анализ зависимостей"
                >
                  <i class="bi bi-layers"></i> Dependencies
                </button>
                <button
                  class="btn btn-outline-primary"
                  data-category="logging"
                  title="Система логирования"
                >
                  <i class="bi bi-file-text"></i> Logging
                </button>
                <button
                  class="btn btn-outline-success"
                  data-category="cicd"
                  title="Непрерывная интеграция"
                >
                  <i class="bi bi-arrow-repeat"></i> CI/CD
                </button>
                <button
                  class="btn btn-outline-dark"
                  data-category="codequality"
                  title="Качество кода"
                >
                  <i class="bi bi-code-slash"></i> Code Quality
                </button>
                <button class="btn btn-outline-secondary" data-category="core" title="Ядро системы">
                  <i class="bi bi-gear"></i> Core
                </button>
                <button
                  class="btn btn-outline-danger"
                  data-category="ai"
                  title="Искусственный интеллект"
                >
                  <i class="bi bi-robot"></i> AI
                </button>
                <button
                  class="btn btn-outline-primary"
                  data-category="architecture"
                  title="Анализ архитектуры"
                >
                  <i class="bi bi-diagram-3"></i> Architecture
                </button>
                <button
                  class="btn btn-outline-secondary"
                  data-category="utils"
                  title="Утилиты и вспомогательные модули"
                >
                  <i class="bi bi-tools"></i> Utils
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Дополнительные контролы -->
      <div class="row mb-4">
        <div class="col-md-8">
          <div class="d-flex gap-2 flex-wrap align-items-center">
            <span class="text-muted">Быстрый доступ:</span>
          </div>
        </div>
        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-upload"></i>
            </span>
            <input
              type="file"
              class="form-control"
              id="report-upload"
              accept=".md,.markdown"
              multiple
            />
          </div>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card h-100 border-success">
            <div class="card-body text-center">
              <i class="bi bi-collection text-success display-4"></i>
              <h3 class="text-success" id="total-components">60+</h3>
              <p class="card-text">Всего компонентов</p>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card h-100 border-primary">
            <div class="card-body text-center">
              <i class="bi bi-graph-up-arrow text-primary display-4"></i>
              <h3 class="text-primary" id="avg-logic">79.2%</h3>
              <p class="card-text">Средняя готовность логики</p>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card h-100 border-info">
            <div class="card-body text-center">
              <i class="bi bi-gear text-info display-4"></i>
              <h3 class="text-info" id="avg-functionality">74.8%</h3>
              <p class="card-text">Средняя функциональность</p>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card h-100 border-warning">
            <div class="card-body text-center">
              <i class="bi bi-trophy text-warning display-4"></i>
              <h3 class="text-warning" id="top-component">EnhancedJest</h3>
              <p class="card-text">Топ компонент</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="row">
        <!-- Category Overview -->
        <div class="col-xl-8 mb-4">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-bar-chart"></i>
                Обзор по категориям
              </h5>
              <div class="btn-group btn-group-sm" role="group">
                <input type="radio" class="btn-check" name="chart-type" id="line-chart" checked />
                <label class="btn btn-outline-secondary" for="line-chart">
                  <i class="bi bi-graph-up"></i>
                </label>
                <input type="radio" class="btn-check" name="chart-type" id="bar-chart" />
                <label class="btn btn-outline-secondary" for="bar-chart">
                  <i class="bi bi-bar-chart"></i>
                </label>
              </div>
            </div>
            <div class="card-body">
              <canvas id="categories-chart" height="300"></canvas>
            </div>
          </div>
        </div>

        <!-- Right Sidebar with Top/Bottom Components -->
        <div class="col-xl-4 mb-4">
          <div class="row">
            <!-- Top Components -->
            <div class="col-6">
              <div class="card h-100">
                <div class="card-header bg-success text-white py-2">
                  <h6 class="mb-0 small">
                    <i class="bi bi-award"></i>
                    🏆 Топ-10
                  </h6>
                </div>
                <div class="card-body py-2" style="max-height: 400px; overflow-y: auto">
                  <div id="top-components-list">
                    <!-- Будет заполнено JavaScript -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Components -->
            <div class="col-6">
              <div class="card h-100">
                <div class="card-header bg-warning text-dark py-2">
                  <h6 class="mb-0 small">
                    <i class="bi bi-exclamation-triangle"></i>
                    🔧 Доработка
                  </h6>
                </div>
                <div class="card-body py-2" style="max-height: 400px; overflow-y: auto">
                  <div id="bottom-components-list">
                    <!-- Будет заполнено JavaScript -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Components View -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-list-task"></i>
                Детальный анализ компонентов (<span id="total-components-count">60</span>)
              </h5>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" id="sort-by-name">
                  <i class="bi bi-sort-alpha-down"></i> По названию
                </button>
                <button class="btn btn-outline-success" id="sort-by-readiness">
                  <i class="bi bi-sort-numeric-down"></i> По готовности
                </button>
                <button class="btn btn-outline-info active" id="sort-by-category">
                  <i class="bi bi-collection"></i> По категориям
                </button>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                  <thead class="table-dark sticky-top">
                    <tr>
                      <th width="20%">Название</th>
                      <th width="15%">Скрипт</th>
                      <th width="30%">Что делает</th>
                      <th width="12%">Логика</th>
                      <th width="12%">Функциональность</th>
                      <th width="11%">Количество тестов</th>
                    </tr>
                  </thead>
                  <tbody id="components-table-body">
                    <!-- Будет заполнено JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Progress Timeline -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-clock-history"></i>
                Временная шкала развития
              </h5>
            </div>
            <div class="card-body">
              <canvas id="timeline-chart" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light text-center py-3 mt-5">
      <div class="container">
        <small class="text-muted">
          EAP Analyzer Dashboard © 2025 | Последнее обновление:
          <span id="footer-update">11.09.2025</span>
        </small>
      </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Chart.js с callback для инициализации -->
    <script>
      // Загружаем Chart.js и ждем его готовности
      const chartScript = document.createElement('script');
      chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
      chartScript.crossOrigin = 'anonymous';
      chartScript.onload = function () {
        console.log('📊 Chart.js загружен успешно');
        console.log('Chart доступен:', typeof Chart !== 'undefined');
        if (typeof Chart !== 'undefined') {
          loadDashboardScripts();
        } else {
          console.error('❌ Chart не стал доступным после загрузки');
        }
      };
      chartScript.onerror = function () {
        console.error('❌ Ошибка загрузки Chart.js, пробуем альтернативный способ');

        // Пробуем загрузить альтернативную версию
        const fallbackScript = document.createElement('script');
        fallbackScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
        fallbackScript.onload = function () {
          console.log('📊 Chart.js v3.9.1 загружен как fallback');
          if (typeof Chart !== 'undefined') {
            loadDashboardScripts();
          } else {
            console.error('❌ Fallback Chart.js также недоступен');
            loadDashboardScripts(); // загружаем остальное без Chart.js
          }
        };
        fallbackScript.onerror = function () {
          console.error('❌ Fallback Chart.js также не загрузился');
          loadDashboardScripts(); // продолжаем без Chart.js
        };
        document.head.appendChild(fallbackScript);
      };
      document.head.appendChild(chartScript);

      // Функция загрузки dashboard скриптов
      function loadDashboardScripts() {
        const timestamp = new Date().getTime();
        const scripts = [
          `js/components.js?v=${timestamp}`,
          `js/parser.js?v=${timestamp}`,
          `js/charts.js?v=${timestamp}`,
          `js/dashboard.js?v=${timestamp}`,
        ];

        let loadedScripts = 0;

        scripts.forEach((src, index) => {
          const script = document.createElement('script');
          script.src = src;
          script.onload = function () {
            loadedScripts++;
            console.log(`✅ Загружен: ${src}`);
            if (loadedScripts === scripts.length) {
              initializeDashboard();
            }
          };
          script.onerror = function () {
            console.error(`❌ Ошибка загрузки: ${src}`);
          };
          document.head.appendChild(script);
        });
      }

      // Инициализация dashboard
      function initializeDashboard() {
        // Проверяем готовность всех компонентов
        if (typeof Chart === 'undefined') {
          console.error('❌ Chart.js не доступен');
          return;
        }

        if (typeof EAP_DATA === 'undefined') {
          console.error('❌ EAP_DATA не доступен');
          return;
        }

        if (typeof EAPDashboard === 'undefined') {
          console.error('❌ EAPDashboard не доступен');
          return;
        }

        console.log('🚀 Инициализация Dashboard...');

        setTimeout(() => {
          try {
            const dashboard = new EAPDashboard();
            const charts = new EAPChartsManager();

            // Делаем charts доступным глобально
            window.EAPCharts = charts;

            // Инициализируем dashboard
            dashboard.initialize();
            console.log('✅ Dashboard инициализирован успешно');
          } catch (error) {
            console.error('❌ Ошибка инициализации Dashboard:', error);
          }
        }, 100);
      }
    </script>

    <!-- Copy to clipboard function -->
    <script>
      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(function () {
            // Show success tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'alert alert-success position-fixed';
            tooltip.style.cssText =
              'top: 20px; right: 20px; z-index: 9999; animation: fadeInOut 2s forwards;';
            tooltip.innerHTML =
              '<i class="bi bi-check-circle"></i> Команда скопирована в буфер обмена!';
            document.body.appendChild(tooltip);

            setTimeout(() => {
              if (tooltip.parentNode) {
                tooltip.parentNode.removeChild(tooltip);
              }
            }, 2000);
          })
          .catch(function (err) {
            console.error('Ошибка копирования: ', err);
            alert('Команда: ' + text);
          });
      }
    </script>

    <!-- CSS for fade animation -->
    <style>
      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translateX(100%);
        }
        20% {
          opacity: 1;
          transform: translateX(0);
        }
        80% {
          opacity: 1;
          transform: translateX(0);
        }
        100% {
          opacity: 0;
          transform: translateX(100%);
        }
      }
    </style>
  </body>
</html>
