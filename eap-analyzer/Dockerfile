# üê≥ Ultimate EAP Analyzer v3.0 - Production Docker Image
FROM node:18-alpine AS builder

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apk add --no-cache \
    git \
    python3 \
    make \
    g++

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
WORKDIR /app

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY package*.json ./

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN npm ci --only=production

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
COPY . .

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
RUN pnpm run build

# –ü—Ä–æ–¥–∞–∫—à–Ω –æ–±—Ä–∞–∑
FROM node:18-alpine AS production

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
RUN apk add --no-cache \
    git \
    curl \
    bash \
    findutils \
    grep \
    && addgroup -g 1001 -S nodejs \
    && adduser -S eap -u 1001

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
WORKDIR /app

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
COPY --from=builder --chown=eap:nodejs /app/dist ./dist
COPY --from=builder --chown=eap:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=eap:nodejs /app/package.json ./

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤
RUN mkdir -p /projects && chown -R eap:nodejs /projects

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV NODE_ENV=production
ENV EAP_WORK_DIR=/projects
ENV EAP_CONFIG_DIR=/app/config
ENV EAP_LOG_LEVEL=info

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
RUN mkdir -p /app/config && chown -R eap:nodejs /app/config

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
COPY <<EOF /app/config/default.json
{
  "analysis": {
    "maxFileSize": "10MB",
    "timeout": 300000,
    "concurrency": 4,
    "excludePaths": [
      "node_modules",
      "dist",
      "build",
      ".git",
      "coverage",
      "test-results"
    ]
  },
  "thresholds": {
    "fileSize": 300,
    "complexity": 15,
    "nesting": 4,
    "duplication": 10,
    "maintainabilityIndex": 65
  },
  "reporting": {
    "format": "markdown",
    "includeDetails": true,
    "generateRoadmap": true
  },
  "encoding": {
    "default": "utf8",
    "detectWin1251": true,
    "convertToUtf8": true
  }
}
EOF

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –∑–∞–ø—É—Å–∫–∞
COPY <<EOF /app/entrypoint.sh
#!/bin/bash
set -e

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[\\$(date +'%Y-%m-%d %H:%M:%S')] EAP: \\$*"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
if [ \\$# -eq 0 ]; then
    log "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: docker run eap-analyzer [OPTIONS] <PROJECT_PATH>"
    log "–û–ø—Ü–∏–∏:"
    log "  --format FORMAT     –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ (markdown, json, html)"
    log "  --output OUTPUT     –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞"
    log "  --config CONFIG     –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
    log "  --verbose           –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ"
    log "  --help              –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_PATH="/projects"
if [ ! -d "\\$PROJECT_PATH" ]; then
    log "–û—à–∏–±–∫–∞: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç –≤ /projects"
    exit 1
fi

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
if [ "\\$EAP_LOG_LEVEL" = "debug" ]; then
    set -x
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Node.js
if ! command -v node &> /dev/null; then
    log "–û—à–∏–±–∫–∞: Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
log "–ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ v\\$(cat package.json | grep version | cut -d '\"' -f 4)"
log "Node.js –≤–µ—Ä—Å–∏—è: \\$(node --version)"
log "–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: \\$(pwd)"
log "–ü—Ä–æ–µ–∫—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: \\$PROJECT_PATH"

# –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
log "–ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∞–ª–∏–∑..."
exec node dist/cli.js "\\$@" "\\$PROJECT_PATH"
EOF

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
RUN chmod +x /app/entrypoint.sh && chown eap:nodejs /app/entrypoint.sh

# –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
USER eap

# –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–∞ (–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
EXPOSE 3000

# –°–æ–∑–¥–∞–Ω–∏–µ volume –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤
VOLUME ["/projects", "/app/reports"]

# –°–æ–∑–¥–∞–Ω–∏–µ health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD node -e "console.log('EAP is healthy')" || exit 1

# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
LABEL maintainer="eap-team@example.com"
LABEL description="–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ü—Ä–æ–µ–∫—Ç–æ–≤ (–≠–ê–ü) - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞"
LABEL version="2.0"
LABEL org.opencontainers.image.title="EAP Analyzer"
LABEL org.opencontainers.image.description="–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º–∏ –ø–æ—Ä–æ–≥–∞–º–∏"
LABEL org.opencontainers.image.vendor="AlphaCore"

# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
ENTRYPOINT ["/app/entrypoint.sh"]
CMD ["--help"]
